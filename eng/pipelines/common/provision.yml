parameters:
  platform : ''

steps:

  # Prepare macOS
  - ${{ if eq(parameters.platform, 'macos') }}:
    # Provision Xcode
    - task: xamops.azdevex.provisionator-task.provisionator@1
      displayName: 'Provision Xcode'
      condition: ne(variables['REQUIRED_XCODE'], '')
      inputs:
        provisioning_script: $(provisionator.xcode)
    # Provision Additional Software
    - task: xamops.azdevex.provisionator-task.provisionator@1
      displayName: 'Provision Additional Software'
      condition: eq(variables['provisioning'], 'true')
      inputs:
        provisioning_script: $(provisionator.path)
        provisioning_extra_args: $(provisionator.extraArguments)
    # Setup SDK Paths
    - bash: |
        echo "##vso[task.prependpath]/Library/Frameworks/Mono.framework/Versions/Current/Commands/"
        echo "##vso[task.prependpath]~/Library/Developer/Xamarin/android-sdk-macosx"
      displayName: 'Setup SDK Paths'
      condition: ne(variables['osx2019VmPool'], 'Azure Pipelines')
    # Setup JDK Paths
    - bash: |
        echo "##vso[task.setvariable variable=JI_JAVA_HOME]$(JAVA_HOME_11_X64)"
      displayName: 'Setup JDK Paths'
    # Configure VS Mac for Xcode
    - bash: |
        set -x
        mkdir -p ~/Library/Preferences/Xamarin
        rm -f ~/Library/Preferences/Xamarin/Settings.plist
        /usr/libexec/PlistBuddy -c "add :AppleSdkRoot string $(dirname $(dirname $(xcode-select -p)))" ~/Library/Preferences/Xamarin/Settings.plist || true
        cat ~/Library/Preferences/Xamarin/Settings.plist || true
      displayName: 'Configure Visual Studio'
    # Install Certificates and Provisioning Profiles
    - task: InstallAppleCertificate@2
      displayName: 'Install Apple Certificats'
      inputs:
        certSecureFile: 'Maui.p12'
        certPwd: $(P12password)
    - task: InstallAppleProvisioningProfile@1
      displayName: 'Install Apple Provisioning Profiles'
      inputs:
        provProfileSecureFile: 'Maui_iOS_Provisioning.mobileprovision'


  # Prepare Windows
  - ${{ if eq(parameters.platform, 'windows') }}:
    - task: xamops.azdevex.provisionator-task.provisionator@1
      displayName: 'Provision Visual Studio'
      inputs:
        provisioning_script: $(provisionator.vs2019)
