parameters:
  platform: '' # [ android, ios ]
  path: '' # path to csproj
  device: '' # the xharness device to use
  cakeArgs: '' # additional cake args

steps:

  - ${{ if eq(parameters['platform'], 'ios') }}:
    - task: InstallAppleCertificate@2
      displayName: 'Install an Apple certificate'
      inputs:
        certSecureFile: 'Maui.p12'
        certPwd: $(P12password)
    - task: InstallAppleProvisioningProfile@1
      displayName: 'Install an Apple provisioning profile'
      inputs:
        provProfileSecureFile: 'Maui_iOS_Provisioning.mobileprovision'

  - template: common/provision.yml
    parameters:
      platform: macos

  - pwsh: ./build.ps1 --target=dotnet --configuration="$(BuildConfiguration)"
    displayName: 'Install .NET'

  - pwsh: ./build.ps1 --target=dotnet-buildtasks --configuration="$(BuildConfiguration)"
    displayName: 'Build the MSBuild Tasks'

  - pwsh: ./build.ps1 eng/devices/${{ parameters.platform }}.cake --project="${{ parameters.path }}" --device=${{ parameters.device }} --results="$(TestResultsDirectory)" --binlog="$(LogDirectory)" ${{ parameters.cakeArgs }}
    displayName: $(Agent.JobName)

  - task: PublishTestResults@2
    displayName: Publish the $(System.PhaseName) test results
    condition: always()
    inputs:
      testResultsFormat: xUnit
      testResultsFiles: '$(TestResultsDirectory)/**/*.xml'
      testRunTitle: '$(System.PhaseName)'

  - task: PublishBuildArtifacts@1
    displayName: Publish Artifacts
    condition: always()
    inputs:
      artifactName: $(System.PhaseName)
