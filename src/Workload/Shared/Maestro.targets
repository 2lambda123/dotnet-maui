<Project>
  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.Arcade.Sdk" Version="$(MicrosoftDotNetBuildTasksFeedVersion)" PrivateAssets="all" GeneratePathProperty="true" />
    <PackageReference Include="Microsoft.DotNet.Build.Tasks.Feed" Version="$(MicrosoftDotNetBuildTasksFeedVersion)" PrivateAssets="all" />
  </ItemGroup>

  <UsingTask TaskName="GenerateBuildManifest" AssemblyFile="$(_MicrosoftDotNetBuildTasksFeedTaskDir)Microsoft.DotNet.Build.Tasks.Feed.dll" />

  <Target Name="PushManifestToBuildAssetRegistry" >
    <ItemGroup>
      <BuildArtifacts Include="$(OutputPath)\**\*.nupkg" />
    </ItemGroup>

    <Error Condition="'@(BuildArtifacts)' == ''" Text="No packages to create manifest from." />

    <PropertyGroup>
      <BUILD_BUILDID>test-buildid</BUILD_BUILDID>
      <SYSTEM_DEFINITIONID>test-defid</SYSTEM_DEFINITIONID>
      <SYSTEM_TEAMPROJECT>test-teamproject</SYSTEM_TEAMPROJECT>
      <BUILD_BUILDNUMBER>test-buildnum</BUILD_BUILDNUMBER>
      <BUILD_REPOSITORY_URI>test-repouri</BUILD_REPOSITORY_URI>
      <BUILD_SOURCEBRANCH>test-sourcebranch</BUILD_SOURCEBRANCH>
      <BUILD_SOURCEVERSION>test-sourcevers</BUILD_SOURCEVERSION>
    </PropertyGroup>

    <ItemGroup>
      <ManifestBuildData Include="InitialAssetsLocation=https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet8/nuget/v3/index.json" />
      <ManifestBuildData Include="AzureDevOpsBuildId=$(BUILD_BUILDID)" />
      <ManifestBuildData Include="AzureDevOpsBuildDefinitionId=$(SYSTEM_DEFINITIONID)" />
      <ManifestBuildData Include="AzureDevOpsProject=$(SYSTEM_TEAMPROJECT)" />
      <ManifestBuildData Include="AzureDevOpsBuildNumber=$(BUILD_BUILDNUMBER)" />
      <ManifestBuildData Include="AzureDevOpsRepository=$(BUILD_REPOSITORY_URI)" />
      <ManifestBuildData Include="AzureDevOpsBranch=$(BUILD_SOURCEBRANCH)" />
    </ItemGroup>

    <GenerateBuildManifest
        Artifacts="@(BuildArtifacts)"
        OutputPath="$(OutputPath)\bar-manifests\AssetManifest.xml"
        BuildId="$(BUILD_BUILDNUMBER)"
        BuildData="@(ManifestBuildData)"
        RepoUri="$(BUILD_REPOSITORY_URI)"
        RepoBranch="$(BUILD_SOURCEBRANCH)"
        RepoCommit="$(BUILD_SOURCEVERSION)"
        PublishingVersion="3" />

    <MSBuild
        Targets="Restore"
        Projects="$(PkgMicrosoft_DotNet_Arcade_Sdk)\tools\SdkTasks\PublishBuildAssets.proj"
        Properties="Configuration=$(Configuration);RepoRoot=$(MauiRootDirectory);VersionPrefix=$(PackageReferenceVersion)"
    />

    <MSBuild
        Projects="$(PkgMicrosoft_DotNet_Arcade_Sdk)\tools\SdkTasks\PublishBuildAssets.proj"
        Properties="Configuration=$(Configuration);RepoRoot=$(MauiRootDirectory);VersionPrefix=$(PackageReferenceVersion);ManifestsPath=$(OutputPath)bar-manifests;MaestroApiEndpoint=https://maestro-prod.westus2.cloudapp.azure.com"
    />
  </Target>

</Project>
